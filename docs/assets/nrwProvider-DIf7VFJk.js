import{_ as e}from"./main-DVnnv9of.js";const t=[5.86,50.32,9.46,52.53],n=["tn-ro:RoadLink","tn-ro:Road","tn-ro:RoadArea","tn-ro:ERoad"],s="http://localhost:3001";let r=1,a=1;function o(e,t){const n=.9996,s=6378137,r=.0818191908426,a=r*r,o=t*Math.PI/180,i=e*Math.PI/180,c=9*Math.PI/180,u=s/Math.sqrt(1-a*Math.sin(o)*Math.sin(o)),l=Math.tan(o)*Math.tan(o),d=a/(1-a)*Math.cos(o)*Math.cos(o),h=(i-c)*Math.cos(o);return[n*u*(h+(1-l+d)*h*h*h/6+(5-18*l+l*l+72*d-a/(1-a)*58)*h*h*h*h*h/120)+5e5,n*(s*(.9983242984527961*o-.002514607060517382*Math.sin(2*o)+26390465943348417e-22*Math.sin(4*o)-35*a*a*a/3072*Math.sin(6*o))+u*Math.tan(o)*(h*h/2+(5-l+9*d+4*d*d)*h*h*h*h/24+(61-58*l+l*l+600*d-a/(1-a)*330)*h*h*h*h*h*h/720))]}function i(e,t){const n=.9996,s=6378137,r=.0818191908426,a=r*r,o=(1-Math.sqrt(1-a))/(1+Math.sqrt(1-a)),i=e-5e5,c=t/n/6367449.145960822,u=c+(3*o/2-27*o*o*o/32)*Math.sin(2*c)+(21*o*o/16-55*o*o*o*o/32)*Math.sin(4*c)+151*o*o*o/96*Math.sin(6*c),l=s/Math.sqrt(1-a*Math.sin(u)*Math.sin(u)),d=Math.tan(u)*Math.tan(u),h=a/(1-a)*Math.cos(u)*Math.cos(u),f=s*(1-a)/Math.pow(1-a*Math.sin(u)*Math.sin(u),1.5),m=i/(l*n),g=u-l*Math.tan(u)/f*(m*m/2-(5+3*d+10*h-4*h*h-a/(1-a)*9)*m*m*m*m/24+(61+90*d+298*h+45*d*d-a/(1-a)*252-3*h*h)*m*m*m*m*m*m/720);return[180*(9+(m-(1+2*d+h)*m*m*m/6+(5-2*h+28*d-3*h*h+a/(1-a)*8+24*d*d)*m*m*m*m*m/120)/Math.cos(u))/Math.PI,180*g/Math.PI]}const c={id:"nrw",supports(e){const n=(e[0]+e[2])/2,s=(e[1]+e[3])/2;var r,a,o,i,c;return c=t,!((i=e)[0]>c[2]||i[2]<c[0]||i[1]>c[3]||i[3]<c[1])||(o=s,(a=n)>=(r=t)[0]&&a<=r[2]&&o>=r[1]&&o<=r[3])},async healthcheck(){try{const e=`${s}/nrw-wfs?service=WFS&request=GetCapabilities`,t=new AbortController,n=setTimeout(()=>t.abort(),5e3),r=await fetch(e,{method:"HEAD",signal:t.signal});return clearTimeout(n),r.ok||405===r.status}catch(e){return!1}},async fetchRoadNetwork(t){const{polygonBbox4326:s}=await e(async()=>{const{polygonBbox4326:e}=await import("./provider-DtzApHY_.js");return{polygonBbox4326:e}},[]),r=function(e,t=1e3){const[n,s,r,a]=e,[i,c]=o(n,s),[u,l]=o(r,a);return[i-t,c-t,u+t,l+t]}(s(t),1e3),i=`${r[0]},${r[1]},${r[2]},${r[3]},EPSG:25832`,c=[],f={};for(const e of n)try{const t=await u(e,i);if(f[e]=t.length,"tn-ro:RoadArea"===e){const e=l(t);c.push(...e)}else c.push(...t)}catch(p){f[e]=0}if(0===c.length)throw new Error("NRW WFS returned no features from any layer");const{nodes:m,ways:g}=function(e,t=!1){const n=[],s=[],r=new Map;for(const o of e.features){if(!o.geometry)continue;const e=o.geometry.type;let i=[];if("LineString"!==e){if("MultiLineString"===e){const e=o.geometry;for(const i of e.coordinates){const e=d(i,n,r,t);if(e.length>1){const t=h(o.properties||{});s.push({id:a++,nodeIds:e,tags:t})}}continue}continue}i=o.geometry.coordinates;const c=d(i,n,r,t);if(c.length>1){const e=h(o.properties||{});s.push({id:a++,nodeIds:c,tags:e})}}return{nodes:n,ways:s}}({features:c},!0);return{nodes:m,ways:g}},makeBasemapLayer:()=>L.tileLayer.wms("https://www.wms.nrw.de/geobasis/wms_nw_dtk",{layers:"nw_dtk_col",format:"image/png",transparent:!1,attribution:"© GEOBASIS.NRW"})};async function u(e,t){const n=new URL(`${s}/nrw-wfs`);n.searchParams.set("service","WFS"),n.searchParams.set("version","2.0.0"),n.searchParams.set("request","GetFeature"),n.searchParams.set("typeNames",e),n.searchParams.set("outputFormat","application/json"),n.searchParams.set("SRSNAME","EPSG:25832"),n.searchParams.set("bbox",t);const r=new AbortController,a=setTimeout(()=>r.abort(),3e4);try{const e=await fetch(n.toString(),{signal:r.signal});if(clearTimeout(a),!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=e.headers.get("content-type")||"";if(t.includes("xml")||t.includes("html")){const n=await e.text();if(n.includes("Exception")||n.includes("error"))throw new Error(`WFS returned error: ${n.substring(0,200)}`);throw new Error(`Unexpected content type: ${t}`)}const s=await e.json();return s&&s.features&&Array.isArray(s.features)?s.features:[]}catch(o){if(clearTimeout(a),"AbortError"===o.name)throw new Error(`Timeout fetching layer ${e}`);throw o}}function l(e){const t=[];for(const n of e){if(!n.geometry)continue;const e=n.geometry.type;if("Polygon"===e){const e=n.geometry.coordinates[0];e&&e.length>2&&t.push({...n,geometry:{type:"LineString",coordinates:e}})}else if("MultiPolygon"===e)for(const s of n.geometry.coordinates){const e=s[0];e&&e.length>2&&t.push({...n,geometry:{type:"LineString",coordinates:e}})}else"LineString"!==e&&"MultiLineString"!==e||t.push(n)}return t}function d(e,t,n,s){const a=[];for(const o of e){if(!o||o.length<2)continue;let e,c;[e,c]=s?i(o[0],o[1]):o;const u=`${e.toFixed(6)},${c.toFixed(6)}`;let l=n.get(u);void 0===l&&(l=r++,t.push({id:l,lon:e,lat:c}),n.set(u,l)),a.push(l)}return a}function h(e){const t={},n=e.roadClass||e.funktionaleStraßenklasse||e.functionalRoadClass||"",s=e.roadType||e.straßenart||"",r=e.localId||e.gml_id||"";if(t.highway=n?f(n):s?f(s):"road",e.maxspeed||e.formOfWay){const n=String(e.formOfWay||"").toLowerCase();n.includes("motorway")||n.includes("autobahn")?t.maxspeed="130":n.includes("dual")||n.includes("schnell")?t.maxspeed="100":e.maxspeed&&(t.maxspeed=String(e.maxspeed))}if(e.surfaceCondition){const n=String(e.surfaceCondition).toLowerCase();n.includes("asphalt")||n.includes("paved")?t.surface="asphalt":(n.includes("gravel")||n.includes("schotter"))&&(t.surface="gravel")}return(e.geographicalName||e.name)&&(t.name=e.geographicalName||e.name),t.source="GEOBASIS.NRW:ATKIS",r&&(t["ref:nrw"]=r),t}function f(e){const t=String(e).toLowerCase();return t.includes("bab")||t.includes("motorway")||t.includes("autobahn")?"motorway":t.includes("bundesstraße")||t.includes("bundesstrasse")||t.includes("federal")?"primary":t.includes("landesstraße")||t.includes("landesstrasse")||t.includes("state")?"secondary":t.includes("kreisstraße")||t.includes("kreisstrasse")||t.includes("county")?"tertiary":t.includes("gemeindestraße")||t.includes("gemeindestrasse")||t.includes("municipal")?"residential":t.includes("motorway")||t.includes("autobahn")?"motorway":t.includes("trunk")||t.includes("schnellstraße")?"trunk":t.includes("primary")||t.includes("hauptstraße")||t.includes("hauptstrasse")?"primary":t.includes("secondary")||t.includes("nebenstraße")?"secondary":t.includes("tertiary")||t.includes("verbindungsstraße")?"tertiary":t.includes("residential")||t.includes("wohngebiet")||t.includes("erschließung")?"residential":t.includes("service")||t.includes("zufahrt")||t.includes("wirtschaftsweg")?"service":t.includes("path")||t.includes("weg")||t.includes("fußweg")?"path":t.includes("track")||t.includes("feldweg")?"track":"road"}export{c as nrwProvider};
